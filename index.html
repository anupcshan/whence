<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whence - Location History</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; font-family: system-ui, -apple-system, sans-serif; }
        
        /* Navigation */
        #nav {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 6px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex;
            gap: 4px;
        }
        #nav button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }
        #nav button:hover { background: #f0f0f0; }
        #nav button.active { background: #007bff; color: white; }
        
        /* Map View */
        #map { height: 100%; width: 100%; }
        #controls {
            position: absolute;
            top: 60px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            width: 180px;
        }
        #controls label { display: block; margin-bottom: 4px; font-size: 12px; color: #666; }
        #controls input { width: 100%; margin-bottom: 10px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; }
        #controls button { 
            width: 100%; 
            padding: 8px; 
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 500;
        }
        #controls button:hover { background: #0056b3; }
        #status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .current-marker { animation: pulse 2s infinite; }
        
        /* Import View */
        #import-view {
            display: none;
            height: 100%;
            background: #f5f5f5;
            padding: 20px;
            overflow-y: auto;
        }
        #import-view.active { display: block; }
        #map-view { height: 100%; }
        #map-view.hidden { display: none; }
        
        .import-container {
            max-width: 800px;
            margin: 40px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
        }
        .import-container h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .status-box {
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .status-box.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .status-box.warning { background: #fff3cd; border: 1px solid #ffeeba; }
        .status-box.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .status-box.info { background: #e7f3ff; border: 1px solid #b8daff; }
        
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-row {
            display: flex;
            gap: 16px;
        }
        .form-row .form-group { flex: 1; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        
        .progress-bar {
            height: 24px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }
        .progress-bar .fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }
        
        .camera-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }
        .camera-table th, .camera-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .camera-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .camera-table tr:hover { background: #f8f9fa; }
        .camera-table input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .stats {
            display: flex;
            gap: 24px;
            margin: 16px 0;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .job-list {
            margin-top: 24px;
        }
        .job-item {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .job-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .job-status.running { background: #fff3cd; color: #856404; }
        .job-status.completed { background: #d4edda; color: #155724; }
        .job-status.failed { background: #f8d7da; color: #721c24; }
        .job-status.interrupted { background: #e2e3e5; color: #383d41; }
        .job-status.cancelled { background: #e2e3e5; color: #383d41; }
        
        #scan-progress, #import-progress { display: none; }
        #camera-selection { display: none; }
        #import-complete { display: none; }
    </style>
</head>
<body>
    <div id="nav">
        <button id="nav-map" class="active">Map</button>
        <button id="nav-import">Import</button>
    </div>
    
    <div id="map-view">
        <div id="map"></div>
        <div id="controls">
            <label>Start Date</label>
            <input type="date" id="startDate">
            <label>End Date</label>
            <input type="date" id="endDate">
            <button id="applyFilter">Apply Filter</button>
        </div>
        <div id="status">Stays: 0</div>
    </div>
    
    <div id="import-view">
        <div class="import-container">
            <h2>Import from Immich</h2>
            
            <div id="immich-status"></div>
            
            <div id="scan-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date (optional)</label>
                        <input type="date" id="import-start">
                    </div>
                    <div class="form-group">
                        <label>End Date (optional)</label>
                        <input type="date" id="import-end">
                    </div>
                </div>
                <button class="btn btn-primary" id="btn-scan">Scan for Photos</button>
            </div>
            
            <div id="scan-progress">
                <h3>Scanning photos...</h3>
                <div class="progress-bar">
                    <div class="fill" id="scan-fill" style="width: 0%">0%</div>
                </div>
                <p id="scan-status">Starting scan...</p>
                <button class="btn btn-secondary" id="btn-cancel-scan">Cancel</button>
            </div>
            
            <div id="camera-selection">
                <h3>Select cameras to import</h3>
                <div class="stats" id="scan-stats"></div>
                <table class="camera-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" checked></th>
                            <th>Camera</th>
                            <th>Photos</th>
                            <th>Date Range</th>
                        </tr>
                    </thead>
                    <tbody id="camera-list"></tbody>
                </table>
                <p id="selection-summary"></p>
                <div class="actions">
                    <button class="btn btn-success" id="btn-import">Start Import</button>
                    <button class="btn btn-secondary" id="btn-rescan">Scan Again</button>
                </div>
            </div>
            
            <div id="import-progress">
                <h3>Importing locations...</h3>
                <div class="progress-bar">
                    <div class="fill" id="import-fill" style="width: 0%">0%</div>
                </div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="stat-imported">0</div>
                        <div class="stat-label">Imported</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-skipped">0</div>
                        <div class="stat-label">Skipped</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="stat-errors">0</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
                <button class="btn btn-secondary" id="btn-cancel-import">Cancel</button>
            </div>
            
            <div id="import-complete">
                <div class="status-box success">
                    <strong>Import complete!</strong>
                    <p id="complete-summary"></p>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" id="btn-view-map">View on Map</button>
                    <button class="btn btn-secondary" id="btn-import-more">Import More</button>
                </div>
            </div>
            
            <div class="job-list" id="job-list">
                <h3>Recent Import Jobs</h3>
                <div id="jobs"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        // Navigation
        const navMap = document.getElementById('nav-map');
        const navImport = document.getElementById('nav-import');
        const mapView = document.getElementById('map-view');
        const importView = document.getElementById('import-view');
        
        navMap.addEventListener('click', () => {
            navMap.classList.add('active');
            navImport.classList.remove('active');
            mapView.classList.remove('hidden');
            importView.classList.remove('active');
        });
        
        navImport.addEventListener('click', () => {
            navImport.classList.add('active');
            navMap.classList.remove('active');
            mapView.classList.add('hidden');
            importView.classList.add('active');
            checkImmichStatus();
            loadJobs();
        });
        
        // Map initialization
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let staysLayer = L.layerGroup().addTo(map);
        let pathsLayer = L.layerGroup().addTo(map);
        let currentLayer = L.layerGroup().addTo(map);

        function formatDateTime(timestamp) {
            const d = new Date(timestamp * 1000);
            const now = new Date();
            const isToday = d.toDateString() === now.toDateString();
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const isYesterday = d.toDateString() === yesterday.toDateString();
            
            const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (isToday) {
                return `Today ${time}`;
            } else if (isYesterday) {
                return `Yesterday ${time}`;
            } else {
                // Show full date for older entries
                const date = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                return `${date} ${time}`;
            }
        }
        
        function formatDateRange(startTs, endTs) {
            const start = new Date(startTs * 1000);
            const end = new Date(endTs * 1000);
            const sameDay = start.toDateString() === end.toDateString();
            
            const startTime = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const endTime = end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const now = new Date();
            const isToday = start.toDateString() === now.toDateString();
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const isYesterday = start.toDateString() === yesterday.toDateString();
            
            let dateStr;
            if (isToday) {
                dateStr = 'Today';
            } else if (isYesterday) {
                dateStr = 'Yesterday';
            } else {
                dateStr = start.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
            }
            
            if (sameDay) {
                return `${dateStr} ${startTime} - ${endTime}`;
            } else {
                const endDateStr = end.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                return `${dateStr} ${startTime} - ${endDateStr} ${endTime}`;
            }
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const hrs = Math.floor(mins / 60);
            const days = Math.floor(hrs / 24);
            
            if (days > 0) {
                const remainingHrs = hrs % 24;
                return `${days}d ${remainingHrs}h`;
            }
            if (hrs > 0) {
                const remainingMins = mins % 60;
                return `${hrs}h ${remainingMins}m`;
            }
            return `${mins}m`;
        }
        
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function renderTimeline(data) {
            staysLayer.clearLayers();
            pathsLayer.clearLayers();
            currentLayer.clearLayers();

            if (data.paths) {
                data.paths.forEach(path => {
                    const latlngs = path.map(p => [p.lat, p.lon]);
                    L.polyline(latlngs, {
                        color: '#3498db',
                        weight: 3,
                        opacity: 0.8
                    }).addTo(pathsLayer);

                    path.forEach(point => {
                        L.circleMarker([point.lat, point.lon], {
                            radius: 6,
                            fillColor: '#3498db',
                            color: '#2980b9',
                            weight: 1,
                            opacity: 0,
                            fillOpacity: 0
                        }).bindPopup(formatDateTime(point.timestamp))
                          .addTo(pathsLayer);
                    });
                });
            }

            if (data.stays) {
                data.stays.forEach(stay => {
                    const duration = stay.end - stay.start;
                    L.circleMarker([stay.lat, stay.lon], {
                        radius: 8,
                        fillColor: '#e74c3c',
                        color: '#c0392b',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).bindPopup(`
                        <strong>${formatDateRange(stay.start, stay.end)}</strong><br>
                        Duration: ${formatDuration(duration)}
                    `).addTo(staysLayer);
                });
            }

            if (data.current) {
                const currentIcon = L.divIcon({
                    className: 'current-marker',
                    html: `<div style="
                        width: 16px;
                        height: 16px;
                        background: #2ecc71;
                        border: 3px solid #27ae60;
                        border-radius: 50%;
                    "></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                L.marker([data.current.lat, data.current.lon], { icon: currentIcon })
                    .bindPopup(`Current: ${formatDateTime(data.current.timestamp)}`)
                    .addTo(currentLayer);
            }

            const stayCount = data.stays ? data.stays.length : 0;
            const pathCount = data.paths ? data.paths.length : 0;
            document.getElementById('status').textContent = `Stays: ${stayCount}, Paths: ${pathCount}`;
        }

        function fetchTimeline() {
            const bounds = map.getBounds();
            const bbox = [
                bounds.getWest(),
                bounds.getSouth(),
                bounds.getEast(),
                bounds.getNorth()
            ].join(',');

            let url = `/api/timeline?bbox=${bbox}`;

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate) {
                url += `&start=${Math.floor(new Date(startDate).getTime() / 1000)}`;
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                url += `&end=${Math.floor(end.getTime() / 1000)}`;
            }

            fetch(url)
                .then(r => r.json())
                .then(renderTimeline)
                .catch(err => console.error('Failed to fetch timeline:', err));
        }

        map.on('moveend', fetchTimeline);
        document.getElementById('applyFilter').addEventListener('click', fetchTimeline);

        fetch('/api/latest')
            .then(r => r.json())
            .then(loc => {
                if (loc) {
                    map.setView([loc.lat, loc.lon], 13);
                } else {
                    fetchTimeline();
                }
            })
            .catch(() => fetchTimeline());
        
        // Import functionality
        let scanEventSource = null;
        let scannedCameras = [];
        let currentJobId = null;
        let pollInterval = null;
        
        function checkImmichStatus() {
            fetch('/api/immich/status')
                .then(r => r.json())
                .then(data => {
                    const statusDiv = document.getElementById('immich-status');
                    if (!data.configured) {
                        statusDiv.innerHTML = `
                            <div class="status-box warning">
                                <strong>Immich not configured</strong>
                                <p>Add immich section to your config.yaml:</p>
                                <pre style="margin-top: 8px; background: #f8f9fa; padding: 8px; border-radius: 4px;">immich:
  url: "https://your-immich-server"
  api_key: "your-api-key"</pre>
                            </div>
                        `;
                        document.getElementById('scan-form').style.display = 'none';
                    } else if (!data.connected) {
                        statusDiv.innerHTML = `
                            <div class="status-box error">
                                <strong>Cannot connect to Immich</strong>
                                <p>${data.error}</p>
                            </div>
                        `;
                        document.getElementById('scan-form').style.display = 'none';
                    } else {
                        statusDiv.innerHTML = `
                            <div class="status-box success">
                                <strong>Connected to Immich</strong>
                                <p>${data.url} (v${data.version})</p>
                            </div>
                        `;
                        document.getElementById('scan-form').style.display = 'block';
                    }
                })
                .catch(err => {
                    document.getElementById('immich-status').innerHTML = `
                        <div class="status-box error">
                            <strong>Error checking Immich status</strong>
                            <p>${err.message}</p>
                        </div>
                    `;
                });
        }
        
        function loadJobs() {
            fetch('/api/immich/jobs')
                .then(r => r.json())
                .then(data => {
                    const jobsDiv = document.getElementById('jobs');
                    if (!data.jobs || data.jobs.length === 0) {
                        jobsDiv.innerHTML = '<p style="color: #666;">No import jobs yet</p>';
                        return;
                    }
                    
                    jobsDiv.innerHTML = data.jobs.slice(0, 5).map(job => `
                        <div class="job-item">
                            <div>
                                <strong>${new Date(job.started_at * 1000).toLocaleString()}</strong>
                                <br><small>Imported: ${job.imported} | Skipped: ${job.skipped}</small>
                            </div>
                            <span class="job-status ${job.status}">${job.status}</span>
                        </div>
                    `).join('');
                })
                .catch(err => console.error('Failed to load jobs:', err));
        }
        
        document.getElementById('btn-scan').addEventListener('click', startScan);
        document.getElementById('btn-cancel-scan').addEventListener('click', cancelScan);
        document.getElementById('btn-rescan').addEventListener('click', () => {
            document.getElementById('camera-selection').style.display = 'none';
            document.getElementById('scan-form').style.display = 'block';
        });
        document.getElementById('btn-import').addEventListener('click', startImport);
        document.getElementById('btn-cancel-import').addEventListener('click', cancelImport);
        document.getElementById('btn-view-map').addEventListener('click', () => {
            navMap.click();
            fetchTimeline();
        });
        document.getElementById('btn-import-more').addEventListener('click', () => {
            document.getElementById('import-complete').style.display = 'none';
            document.getElementById('scan-form').style.display = 'block';
            loadJobs();
        });
        
        document.getElementById('select-all').addEventListener('change', (e) => {
            document.querySelectorAll('#camera-list input[type="checkbox"]').forEach(cb => {
                cb.checked = e.target.checked;
            });
            updateSelectionSummary();
        });
        
        function startScan() {
            const startDate = document.getElementById('import-start').value;
            const endDate = document.getElementById('import-end').value;
            
            let url = '/api/immich/preview?';
            if (startDate) url += `after=${startDate}T00:00:00Z&`;
            if (endDate) url += `before=${endDate}T23:59:59Z&`;
            
            document.getElementById('scan-form').style.display = 'none';
            document.getElementById('scan-progress').style.display = 'block';
            document.getElementById('scan-fill').style.width = '0%';
            document.getElementById('scan-fill').textContent = '0%';
            
            scannedCameras = [];
            
            scanEventSource = new EventSource(url);
            
            scanEventSource.addEventListener('progress', (e) => {
                const data = JSON.parse(e.data);
                const percent = Math.round(data.percent);
                document.getElementById('scan-fill').style.width = `${percent}%`;
                document.getElementById('scan-fill').textContent = `${percent}%`;
                document.getElementById('scan-status').textContent = 
                    `Scanned ${data.scanned.toLocaleString()} photos, found ${data.photos_with_gps.toLocaleString()} with GPS`;
                scannedCameras = data.cameras;
            });
            
            scanEventSource.addEventListener('complete', (e) => {
                const data = JSON.parse(e.data);
                scannedCameras = data.cameras;
                scanEventSource.close();
                showCameraSelection(data);
            });
            
            scanEventSource.addEventListener('error', (e) => {
                let errorMsg = 'Scan failed';
                try {
                    const data = JSON.parse(e.data);
                    errorMsg = data.error || errorMsg;
                } catch {}
                scanEventSource.close();
                document.getElementById('scan-progress').style.display = 'none';
                document.getElementById('scan-form').style.display = 'block';
                document.getElementById('immich-status').innerHTML = `
                    <div class="status-box error">
                        <strong>Scan failed</strong>
                        <p>${errorMsg}</p>
                    </div>
                `;
            });
        }
        
        function cancelScan() {
            if (scanEventSource) {
                scanEventSource.close();
                scanEventSource = null;
            }
            document.getElementById('scan-progress').style.display = 'none';
            document.getElementById('scan-form').style.display = 'block';
        }
        
        function showCameraSelection(data) {
            document.getElementById('scan-progress').style.display = 'none';
            document.getElementById('camera-selection').style.display = 'block';
            
            document.getElementById('scan-stats').innerHTML = `
                <div class="stat">
                    <div class="stat-value">${data.scanned.toLocaleString()}</div>
                    <div class="stat-label">Total Photos</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${data.photos_with_gps.toLocaleString()}</div>
                    <div class="stat-label">With GPS</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${data.cameras.length}</div>
                    <div class="stat-label">Cameras</div>
                </div>
            `;
            
            const tbody = document.getElementById('camera-list');
            tbody.innerHTML = data.cameras.map(cam => `
                <tr>
                    <td><input type="checkbox" checked data-device="${cam.device_id}" data-count="${cam.count}"></td>
                    <td>${cam.device_id}</td>
                    <td>${cam.count.toLocaleString()}</td>
                    <td>${formatDate(cam.earliest)} - ${formatDate(cam.latest)}</td>
                </tr>
            `).join('');
            
            tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', updateSelectionSummary);
            });
            
            updateSelectionSummary();
        }
        
        function updateSelectionSummary() {
            const checkboxes = document.querySelectorAll('#camera-list input[type="checkbox"]:checked');
            let totalPhotos = 0;
            checkboxes.forEach(cb => {
                totalPhotos += parseInt(cb.dataset.count);
            });
            document.getElementById('selection-summary').textContent = 
                `Selected: ${totalPhotos.toLocaleString()} photos from ${checkboxes.length} camera(s)`;
        }
        
        function startImport() {
            const selectedCameras = [];
            document.querySelectorAll('#camera-list input[type="checkbox"]:checked').forEach(cb => {
                selectedCameras.push(cb.dataset.device);
            });
            
            if (selectedCameras.length === 0) {
                alert('Please select at least one camera');
                return;
            }
            
            const startDate = document.getElementById('import-start').value;
            const endDate = document.getElementById('import-end').value;
            
            const body = {
                cameras: selectedCameras
            };
            if (startDate) body.after = `${startDate}T00:00:00Z`;
            if (endDate) body.before = `${endDate}T23:59:59Z`;
            
            document.getElementById('camera-selection').style.display = 'none';
            document.getElementById('import-progress').style.display = 'block';
            
            fetch('/api/immich/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(r => r.json())
            .then(data => {
                currentJobId = data.job_id;
                pollJobProgress();
            })
            .catch(err => {
                document.getElementById('import-progress').style.display = 'none';
                document.getElementById('camera-selection').style.display = 'block';
                alert('Failed to start import: ' + err.message);
            });
        }
        
        function pollJobProgress() {
            if (!currentJobId) return;
            
            pollInterval = setInterval(() => {
                fetch(`/api/immich/jobs/${currentJobId}`)
                    .then(r => r.json())
                    .then(data => {
                        const percent = Math.round(data.percent) || 0;
                        document.getElementById('import-fill').style.width = `${percent}%`;
                        document.getElementById('import-fill').textContent = `${percent}%`;
                        document.getElementById('stat-imported').textContent = data.imported.toLocaleString();
                        document.getElementById('stat-skipped').textContent = data.skipped.toLocaleString();
                        document.getElementById('stat-errors').textContent = data.errors.toLocaleString();
                        
                        if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
                            clearInterval(pollInterval);
                            showImportComplete(data);
                        }
                    })
                    .catch(err => {
                        console.error('Failed to poll job:', err);
                    });
            }, 1000);
        }
        
        function cancelImport() {
            if (!currentJobId) return;
            
            fetch(`/api/immich/jobs/${currentJobId}/cancel`, { method: 'POST' })
                .then(() => {
                    clearInterval(pollInterval);
                    document.getElementById('import-progress').style.display = 'none';
                    document.getElementById('scan-form').style.display = 'block';
                    loadJobs();
                })
                .catch(err => alert('Failed to cancel: ' + err.message));
        }
        
        function showImportComplete(data) {
            document.getElementById('import-progress').style.display = 'none';
            document.getElementById('import-complete').style.display = 'block';
            
            let summary = `Imported ${data.imported.toLocaleString()} locations`;
            if (data.skipped > 0) summary += `, skipped ${data.skipped.toLocaleString()} duplicates`;
            if (data.errors > 0) summary += `, ${data.errors.toLocaleString()} errors`;
            
            document.getElementById('complete-summary').textContent = summary;
            loadJobs();
        }
    </script>
</body>
</html>
