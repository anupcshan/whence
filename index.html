<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whence - Location History</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; font-family: system-ui, sans-serif; }
        #map { height: 100%; width: 100%; }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #controls label { display: block; margin-bottom: 5px; font-size: 12px; }
        #controls input { margin-bottom: 10px; }
        #controls button { 
            width: 100%; 
            padding: 5px; 
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
        }
        #controls button:hover { background: #0056b3; }
        #status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .current-marker {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <label>Start Date</label>
        <input type="date" id="startDate">
        <label>End Date</label>
        <input type="date" id="endDate">
        <button id="applyFilter">Apply Filter</button>
    </div>
    <div id="status">Stays: 0</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Layer groups for different elements
        let staysLayer = L.layerGroup().addTo(map);
        let pathsLayer = L.layerGroup().addTo(map);
        let currentLayer = L.layerGroup().addTo(map);

        function formatTime(timestamp) {
            return new Date(timestamp * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const hrs = Math.floor(mins / 60);
            if (hrs > 0) {
                const remainingMins = mins % 60;
                return `${hrs}h ${remainingMins}m`;
            }
            return `${mins}m`;
        }

        function renderTimeline(data) {
            staysLayer.clearLayers();
            pathsLayer.clearLayers();
            currentLayer.clearLayers();

            // Render paths (blue polylines)
            if (data.paths) {
                data.paths.forEach(path => {
                    const latlngs = path.map(p => [p.lat, p.lon]);
                    const polyline = L.polyline(latlngs, {
                        color: '#3498db',
                        weight: 3,
                        opacity: 0.8
                    }).addTo(pathsLayer);

                    // Make path segments clickable
                    path.forEach(point => {
                        L.circleMarker([point.lat, point.lon], {
                            radius: 6,
                            fillColor: '#3498db',
                            color: '#2980b9',
                            weight: 1,
                            opacity: 0,
                            fillOpacity: 0
                        }).bindPopup(formatTime(point.timestamp))
                          .addTo(pathsLayer);
                    });
                });
            }

            // Render stays (red markers)
            if (data.stays) {
                data.stays.forEach(stay => {
                    const duration = stay.end - stay.start;
                    const marker = L.circleMarker([stay.lat, stay.lon], {
                        radius: 8,
                        fillColor: '#e74c3c',
                        color: '#c0392b',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).bindPopup(`
                        <strong>${formatTime(stay.start)} - ${formatTime(stay.end)}</strong><br>
                        Duration: ${formatDuration(duration)}
                    `).addTo(staysLayer);
                });
            }

            // Render current location (pulsing blue marker)
            if (data.current) {
                const currentIcon = L.divIcon({
                    className: 'current-marker',
                    html: `<div style="
                        width: 16px;
                        height: 16px;
                        background: #2ecc71;
                        border: 3px solid #27ae60;
                        border-radius: 50%;
                    "></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                L.marker([data.current.lat, data.current.lon], { icon: currentIcon })
                    .bindPopup(`Current: ${formatTime(data.current.timestamp)}`)
                    .addTo(currentLayer);
            }

            // Update status
            const stayCount = data.stays ? data.stays.length : 0;
            const pathCount = data.paths ? data.paths.length : 0;
            document.getElementById('status').textContent = `Stays: ${stayCount}, Paths: ${pathCount}`;
        }

        function fetchTimeline() {
            const bounds = map.getBounds();
            const bbox = [
                bounds.getWest(),
                bounds.getSouth(),
                bounds.getEast(),
                bounds.getNorth()
            ].join(',');

            let url = `/api/timeline?bbox=${bbox}`;

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate) {
                url += `&start=${Math.floor(new Date(startDate).getTime() / 1000)}`;
            }
            if (endDate) {
                // End of the selected day
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                url += `&end=${Math.floor(end.getTime() / 1000)}`;
            }

            fetch(url)
                .then(r => r.json())
                .then(renderTimeline)
                .catch(err => {
                    console.error('Failed to fetch timeline:', err);
                });
        }

        map.on('moveend', fetchTimeline);
        document.getElementById('applyFilter').addEventListener('click', fetchTimeline);

        // Center on most recent location, then fetch
        fetch('/api/latest')
            .then(r => r.json())
            .then(loc => {
                if (loc) {
                    map.setView([loc.lat, loc.lon], 13);
                } else {
                    fetchTimeline();
                }
            })
            .catch(() => fetchTimeline());
    </script>
</body>
</html>
